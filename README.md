# vafast 框架性能评测

这是一个综合性的框架性能测试工具，对比主流框架与 vafast 原生框架的性能表现。

## 🚀 功能特性

- **简单响应性能测试**: 测试各框架处理简单请求的性能
- **复杂验证器性能测试**: 测试各框架使用 TypeBox 验证器的性能
- **并发性能测试**: 测试各框架在高并发场景下的表现
- **内存监控**: 实时监控测试过程中的内存使用情况
- **错误处理**: 完善的错误处理和成功率统计

## 🔧 已修复的问题

### 1. 测试环境不一致性
- ✅ 修复了 Express 应用的路由注册问题
- ✅ 统一了所有框架的测试环境

### 2. 验证器测试不公平对比
- ✅ 修复了 Hono 验证器只验证 body 不验证 query 的问题
- ✅ 预编译 Express 验证器，避免重复编译
- ✅ 确保所有框架验证相同的数据

### 3. 内存泄漏风险
- ✅ 降低了并发测试的请求数量（从5000万降到100万）
- ✅ 减少了并发线程数（从1000降到100）
- ✅ 添加了内存监控和垃圾回收控制

### 4. 测试数据问题
- ✅ 优化了 Request 对象的复用
- ✅ 添加了错误处理和成功率统计

### 5. 性能测量不准确
- ✅ 增加了预热次数（从1000增加到5000）
- ✅ 添加了垃圾回收控制
- ✅ 改进了内存使用监控

## 📊 测试配置

```typescript
const TEST_CONFIG = {
  iterations: 500_000,        // 单线程测试次数
  concurrency: 100,           // 并发测试线程数
  totalRequests: 1_000_000,   // 并发测试总请求数
  warmupRequests: 5000,       // 预热请求数
  validatorIterations: 1000,  // 验证器测试次数
  validatorRuns: 5,           // 验证器测试运行次数
  gcInterval: 10000,          // 垃圾回收间隔
};
```

## 🚀 运行方法

### 安装依赖
```bash
npm install
# 或
bun install
```

### 运行测试
```bash
# 使用 Node.js
node --expose-gc comprehensive-benchmark.ts

# 使用 Bun
bun run comprehensive-benchmark.ts
```

## 📈 测试结果解读

### 性能指标
- **RPS (Requests Per Second)**: 每秒处理的请求数
- **成功率**: 并发测试中的成功请求比例
- **内存使用**: 测试过程中的内存占用情况

### 框架对比
1. **原生 Response**: 性能基准
2. **vafast 原生**: 直接路由、工厂路由、带验证版本
3. **Elysia**: 现代 TypeScript 框架
4. **Hono**: 轻量级 Web 框架
5. **Express**: 传统 Node.js 框架

## 🎯 使用建议

- **极简路由**: 使用直接路由（性能最佳）
- **简单路由**: 使用工厂路由（平衡性能与功能）
- **复杂业务**: 使用带验证版本（功能最全）

## ⚠️ 注意事项

1. 确保系统有足够的内存运行测试
2. 测试过程中会显示内存使用情况
3. 如果内存使用率过高，建议增加系统内存
4. 并发测试会显示成功率，帮助识别稳定性问题

## 🔍 技术细节

- 使用 TypeBox 进行数据验证
- 支持 Web Request/Response API
- 内置内存监控和垃圾回收控制
- 完善的错误处理和统计报告

## 📝 更新日志

### v1.1.0
- 修复了测试环境不一致性问题
- 优化了验证器测试的公平性
- 添加了内存监控和垃圾回收控制
- 改进了错误处理和成功率统计
- 降低了并发测试的资源消耗
