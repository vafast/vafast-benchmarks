## 1. Vafast Benchmarks

Vafast 框架性能基准测试项目，对比主流 Node.js Web 框架与 Vafast 原生框架的性能表现。

## 2. 📋 项目概述

本项目旨在通过严格的性能测试，验证 Vafast 框架在不同场景下的性能表现，并与主流框架进行对比分析。

### 🎯 测试目标

1. **简单响应性能测试**: 对比基础路由响应性能
2. **验证器性能测试**: 对比包含数据验证的复杂场景性能
3. **内存使用分析**: 监控测试过程中的内存占用情况
4. **单线程性能验证**: 确保框架在单线程环境下的优化效果

## 3. 🚀 快速开始

### 最低环境要求

1. Node.js 18+ 或 Bun 1.0+
2. 支持 ES Modules
3. **k6 性能测试工具** (推荐)

### 安装依赖

```bash
# 1. 使用 npm
npm install

# 2. 使用 yarn
yarn install

# 3. 使用 bun
bun install
```

### 安装 k6 性能测试工具

```bash
# macOS (使用 Homebrew)
brew install k6

# Windows (使用 Chocolatey)
choco install k6

# Linux (Ubuntu/Debian)
sudo gpg -k
sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6

# 验证安装
k6 version
```

### 启动框架服务

```bash
# 启动所有框架服务
bun run start:servers

# 或者使用 npm
npm run start:servers
```

### 运行性能测试

#### 🧪 使用优化的 k6 测试套件 (推荐)

```bash
# 冒烟测试 - 快速验证基本功能
node run-k6-tests.js smoke

# 平均负载测试 - 模拟正常流量
node run-k6-tests.js average

# 压力测试 - 找到系统极限
node run-k6-tests.js stress

# 峰值测试 - 测试最大容量
node run-k6-tests.js peak

# 运行多个测试类型
node run-k6-tests.js smoke average stress
```

#### 📊 使用传统测试方式

```bash
# 简单响应性能测试
bun run src/simple-response-benchmark.ts

# 验证器性能测试
bun run src/validator-benchmark.ts

# 批量框架测试
bun run test:batch

# 单个框架测试
bun run test:single
```

#### 🚀 使用 package.json 脚本 (推荐)

```bash
# k6 测试脚本
npm run test:k6:smoke      # 冒烟测试
npm run test:k6:average    # 平均负载测试
npm run test:k6:stress     # 压力测试
npm run test:k6:peak       # 峰值测试
npm run test:k6:all        # 运行所有测试
npm run test:k6:quick      # 快速测试 (冒烟+平均负载)

# 或者使用 bun
bun run test:k6:smoke
bun run test:k6:average
bun run test:k6:stress
bun run test:k6:peak
bun run test:k6:all
bun run test:k6:quick
```

## 4. 📊 性能测试

### 🏆 最新10秒持续测试结果 (2025-08-20)

**测试配置**: 10秒持续测试，极致性能表现

| 框架 | 冷启动时间 | 总请求数 | RPS | 平均延迟 | 性能表现 |
|------|------------|----------|-----|----------|----------|
| **Elysia** | 0.00ms | 392,094 | 39,208.28 | 0.08ms | 🥇 极致性能 |
| **Vafast-Mini** | 0.00ms | 384,236 | 38,422.78 | 0.08ms | 🥈 极致性能 |
| **Vafast** | 0.00ms | 362,541 | 36,251.67 | 0.09ms | 🥉 极致性能 |
| **Hono** | 0.00ms | 370,265 | 37,020.54 | 0.09ms | 4 | 极致性能 |
| **Express** | 0.00ms | 337,123 | 33,710.63 | 0.11ms | 5 | 极致性能 |
| **Koa** | 0.00ms | 307,477 | 30,746.57 | 0.12ms | 6 | 极致性能 |

### 🚀 极致性能分析

**所有框架都达到了极致性能水平！**

- **冷启动**: 所有框架均为 0.00ms，无延迟启动
- **吞吐量**: 所有框架均超过 30,000 RPS
- **延迟**: 所有框架延迟均在 0.08-0.12ms 范围内
- **稳定性**: 10秒持续测试，无错误，性能稳定

### 🏆 最新批量测试结果 (2025-08-20)

**测试配置**: 5秒持续测试，多框架并发对比

| 框架 | 冷启动时间 | 总请求数 | RPS | 平均延迟 | P95延迟 | 错误率 | 排名 |
|------|------------|----------|-----|----------|----------|--------|------|
| **Vafast** | 1.73ms | 143,733 | 28,746.76 | 0.42ms | 0.63ms | 0.03% | 🥇 第一 |
| **Vafast-mini** | 1.59ms | 128,902 | 25,780.45 | 0.33ms | 0.50ms | 0.08% | 🥈 第二 |
| **Koa** | 1.16ms | 111,317 | 22,263.60 | 0.34ms | 0.52ms | 0.05% | 🥉 第三 |
| **Hono** | 0.98ms | 107,541 | 21,508.25 | 0.16ms | 0.23ms | 0.06% | 4 |
| **Express** | 1.12ms | 103,410 | 20,682.06 | 0.26ms | 0.39ms | 0.02% | 5 |
| **Elysia** | 0.52ms | 93,746 | 18,749.36 | 0.14ms | 0.21ms | 0.05% | 6 |

### ❄️ 冷启动性能排名

| 排名 | 框架 | 冷启动时间 | 性能表现 |
|------|------|------------|----------|
| 🥇 | **Elysia** | 0.52ms | 极速启动 |
| 🥈 | **Hono** | 0.98ms | 快速启动 |
| 🥉 | **Express** | 1.12ms | 良好启动 |
| 4 | **Koa** | 1.16ms | 良好启动 |
| 5 | **Vafast-mini** | 1.59ms | 中等启动 |
| 6 | **Vafast** | 1.73ms | 中等启动 |

### ⚡️ 吞吐量性能排名 (RPS)

| 排名 | 框架 | RPS | 相对性能 |
|------|------|-----|----------|
| 🥇 | **Vafast** | 28,746.76 | 100% (基准) |
| 🥈 | **Vafast-mini** | 25,780.45 | 89.7% |
| 🥉 | **Koa** | 22,263.60 | 77.4% |
| 4 | **Hono** | 21,508.25 | 74.8% |
| 5 | **Express** | 20,682.06 | 72.0% |
| 6 | **Elysia** | 18,749.36 | 65.2% |

### 📉 延迟性能排名

| 排名 | 框架 | 平均延迟 | P95延迟 | 性能表现 |
|------|------|----------|----------|----------|
| 🥇 | **Elysia** | 0.14ms | 0.21ms | 极低延迟 |
| 🥈 | **Hono** | 0.16ms | 0.23ms | 极低延迟 |
| 🥉 | **Express** | 0.26ms | 0.39ms | 低延迟 |
| 4 | **Vafast-mini** | 0.33ms | 0.50ms | 低延迟 |
| 5 | **Koa** | 0.34ms | 0.52ms | 低延迟 |
| 6 | **Vafast** | 0.42ms | 0.63ms | 中等延迟 |

### 简单响应性能测试

运行简单响应性能测试：

```bash
bun run src/simple-response-benchmark.ts
```

**测试结果 (100,000 次迭代)**
*测试时间: 2025-08-20 19:33:34 (北京时间)*

| 框架 | 版本 | 请求/秒 | 平均耗时 | 总耗时 | 排名 | 相对性能 |
|------|------|----------|----------|--------|------|----------|
| vafast原生 (工厂路由) | 0.1.4 | 816.98K (100%) | 1.22μs | 122.40ms | 🥇 第一 | 1.00x |
| vafast原生 (直接路由) | 0.1.4 | 592.57K (72.5%) | 1.69μs | 168.76ms | 🥈 第二 | 0.73x |
| Koa | 3.0.1 | 451.96K (55.3%) | 2.21μs | 221.26ms | 🥉 第三 | 0.55x |
| 原生 Response | - | 389.76K (47.7%) | 2.57μs | 256.57ms | 4 | 0.48x |
| Elysia | 1.3.13 | 307.59K (37.6%) | 3.25μs | 325.11ms | 5 | 0.38x |
| Hono | 4.9.2 | 261.16K (32.0%) | 3.83μs | 382.90ms | 6 | 0.32x |
| Express | 5.1.0 | 246.72K (30.2%) | 4.05μs | 405.31ms | 7 | 0.30x |

### 验证器性能测试

运行验证器性能测试：

```bash
bun run src/validator-benchmark.ts
```

**测试结果 (100,000 次迭代，包含 TypeBox 验证器)**
*测试时间: 2025-08-20 19:33:44 (北京时间)*

| 框架 | 版本 | 请求/秒 | 平均耗时 | 总耗时 | 排名 | 相对性能 |
|------|------|----------|----------|--------|------|----------|
| vafast原生 (TypeBox验证器) | 0.1.4 | 310.94K (100%) | 3.22μs | 321.61ms | 🥇 第一 | 1.00x |
| Elysia (TypeBox验证器) | 1.3.13 | 286.43K (92.1%) | 3.49μs | 349.13ms | 🥈 第二 | 0.92x |
| Express (TypeBox验证器) | 5.1.0 | 274.92K (88.4%) | 3.64μs | 363.74ms | 🥉 第三 | 0.88x |
| Hono (TypeBox验证器) | 4.9.2 | 162.28K (52.2%) | 6.16μs | 616.24ms | 4 | 0.52x |
| Koa (TypeBox验证器) | 3.0.1 | 34.01K (10.9%) | 29.41μs | 2.94s | 5 | 0.11x |

## 5. 🏆 性能分析

### 🚀 10秒持续测试场景 - 极致性能时代

**这是一个令人振奋的结果！所有框架都达到了极致性能水平：**

1. **Elysia** 以 39,208 RPS 和 0.08ms 延迟领跑，展现了现代框架的极致性能
2. **Vafast-Mini** 以 38,423 RPS 紧随其后，证明了轻量级框架也能达到极致性能
3. **Vafast** 以 36,252 RPS 展现了原生框架的强大实力
4. **Hono** 以 37,021 RPS 证明了其在高负载下的稳定性
5. **Express** 以 33,711 RPS 展现了传统框架的持续优化成果
6. **Koa** 以 30,747 RPS 证明了中间件架构的潜力

### 🚀 批量测试场景

1. **Vafast 原生框架** 在吞吐量方面表现最佳，达到 28,746 RPS
2. **Vafast-mini** 在保持高性能的同时，提供了更轻量的选择
3. **Koa** 在传统框架中表现优秀，平衡了性能和易用性
4. **Elysia** 在冷启动和延迟方面表现最佳，适合快速响应场景

### 简单响应场景

1. **原生 Response** 表现最佳，作为基准参考
2. **Vafast 直接路由** 性能接近原生，仅损失 4.3%
3. **Vafast 工厂路由** 在功能与性能间取得平衡
4. 传统框架在简单场景下性能相对较低

### 验证器场景

1. **Vafast 原生验证器** 性能领先，验证开销最小
2. **Elysia** 验证器性能接近 Vafast，表现优秀
3. **Hono** 验证器性能中等，适合中等复杂度项目
4. **Express/Koa** 验证器性能较低，适合简单项目

## 6. 💡 使用建议

### 性能优先场景

1. **极简路由**: 使用 Vafast 直接路由获得最佳性能
2. **简单验证**: 使用 Vafast 原生验证器平衡性能和功能

### 功能优先场景

1. **复杂业务**: 使用完整验证获得全部功能
2. **团队开发**: 选择熟悉的传统框架降低学习成本

## 7. 🔧 项目结构

```
vafast-benchmarks/
├── src/
│   ├── config/                 # 测试配置文件
│   │   ├── simple-response-config.ts
│   │   └── validator-config.ts
│   ├── simple-response-benchmark.ts    # 简单响应测试
│   ├── validator-benchmark.ts          # 验证器测试
│   └── utils/                          # 工具函数
│       ├── benchmark-utils.ts
│       └── report-utils.ts
├── test-results/              # 测试结果目录
│   ├── batch-test/            # 批量测试结果
│   └── demo-test/             # 演示测试结果
├── k6-test-config.js          # k6 测试配置文件 (基于官方最佳实践)
├── run-k6-tests.js            # k6 测试运行脚本
├── package.json
└── README.md
```

## 8. 📈 测试环境

1. **运行时**: Node.js 24.3.0
2. **平台**: macOS (darwin arm64)
3. **测试配置**: 100,000 次请求，5,000 次预热
4. **内存监控**: 实时监控测试前后内存使用情况
5. **测试时间**: 2025-08-20 19:33:44 (北京时间)

## 9. 📦 依赖版本

### 核心框架
1. **vafast**: 0.1.4
2. **elysia**: 1.3.13
3. **hono**: 4.9.2
4. **express**: 5.1.0
5. **koa**: 3.0.1

### 验证器
1. **@sinclair/typebox**: 0.32.0
2. **@hono/typebox-validator**: 0.2.0
3. **koa-bodyparser**: 4.4.1

## 10. 🎯 关键性能指标

### 🏆 综合性能冠军
- **最高吞吐量**: Elysia (39,208 RPS) - 10秒持续测试
- **最低延迟**: Elysia (0.08ms) - 极致响应速度
- **最快冷启动**: 所有框架均为 0.00ms - 无延迟启动
- **最佳平衡**: Vafast-Mini (38,423 RPS + 0.08ms) - 性能与轻量的完美结合

### 📊 性能对比总结
- **10秒持续测试**: 所有框架均超过 30,000 RPS，进入极致性能时代
- **冷启动性能**: 所有框架均为 0.00ms，无延迟启动成为标配
- **延迟表现**: 所有框架延迟均在 0.08-0.12ms 范围内，响应速度极快
- **稳定性**: 10秒持续测试无错误，性能稳定可靠

### 🚀 性能突破亮点
- **Elysia**: 39,208 RPS 刷新了性能记录
- **Vafast-Mini**: 38,423 RPS 证明了轻量级框架的极致性能
- **Vafast**: 36,252 RPS 展现了原生框架的强大实力
- **Hono**: 37,021 RPS 在高负载下保持稳定
- **Express**: 33,711 RPS 传统框架的持续优化成果
- **Koa**: 30,747 RPS 中间件架构的潜力体现

## 11. 🤝 贡献

欢迎提交 Issue 和 Pull Request 来改进测试用例和性能分析。

## 12. 📄 许可证

本项目采用 MIT 许可证。

## 13. 🧪 k6 性能测试详解

### 🎯 测试类型说明

#### 1. **冒烟测试 (Smoke Test)**
- **目的**: 验证基本功能，快速发现问题
- **配置**: 5秒内增加到5个用户，保持5秒，然后减少到0
- **适用场景**: 开发环境验证、CI/CD 快速检查
- **预期结果**: 所有请求成功，响应时间 < 500ms

#### 2. **平均负载测试 (Average Load Test)**
- **目的**: 模拟正常流量，测试系统稳定性
- **配置**: 10秒内增加到20个用户，保持30秒，然后减少到0
- **适用场景**: 性能基准测试、日常性能监控
- **预期结果**: 系统稳定运行，错误率 < 1%

#### 3. **压力测试 (Stress Test)**
- **目的**: 找到系统极限，测试高负载表现
- **配置**: 逐步增加到100个用户，测试系统边界
- **适用场景**: 容量规划、性能瓶颈识别
- **预期结果**: 找到性能拐点，了解系统极限

#### 4. **峰值测试 (Peak Test)**
- **目的**: 测试最大容量，验证系统边界
- **配置**: 快速增加到200个用户，测试最大并发
- **适用场景**: 峰值流量测试、灾难恢复验证
- **预期结果**: 验证系统在高负载下的稳定性

### ⚙️ 测试配置详解

#### 阈值设置 (Thresholds)
```javascript
thresholds: {
  // 可用性阈值 - 错误率必须小于1%
  http_req_failed: ['rate<0.01'],
  // 延迟阈值 - 99%的请求必须在1秒内完成
  http_req_duration: ['p(99)<1000'],
  // 自定义指标阈值
  'response_time': ['p(95)<300', 'p(99)<800'],
  'cold_start_time': ['p(95)<10'],
  // 吞吐量阈值
  'throughput': ['rate>1000'], // 至少1000 RPS
}
```

#### 执行器配置 (Executors)
- **ramping-vus**: 虚拟用户数量随时间变化
- **gracefulRampDown**: 优雅关闭，避免突然中断
- **stages**: 分阶段负载，模拟真实流量模式

### 📊 性能指标说明

#### 核心指标
- **RPS (Requests Per Second)**: 每秒请求数，衡量吞吐量
- **延迟 (Latency)**: 响应时间，包括 P50、P95、P99 分位数
- **错误率 (Error Rate)**: 请求失败比例，衡量可用性
- **冷启动时间 (Cold Start)**: 首次请求响应时间

#### 自定义指标
- **吞吐量 (Throughput)**: 自定义吞吐量指标
- **响应时间趋势 (Response Time Trend)**: 响应时间变化趋势
- **错误率统计 (Error Rate)**: 详细错误统计

### 🚀 最佳实践

#### 测试环境准备
1. **服务启动**: 确保所有框架服务正常运行
2. **端口检查**: 自动检测服务可用性
3. **环境隔离**: 避免影响生产环境

#### 测试执行策略
1. **渐进式测试**: 从冒烟测试开始，逐步增加负载
2. **监控指标**: 实时监控关键性能指标
3. **结果分析**: 生成详细测试报告和性能评估

#### 性能优化建议
1. **阈值设置**: 根据业务需求设置合理的性能阈值
2. **负载模式**: 模拟真实的用户行为模式
3. **资源监控**: 监控系统资源使用情况

### 🔧 故障排除

#### 常见问题
1. **服务不可用**: 检查框架服务是否正常启动
2. **端口冲突**: 确认端口配置正确
3. **k6未安装**: 按照安装说明安装k6工具

#### 调试技巧
1. **日志输出**: 启用详细日志输出
2. **指标监控**: 实时监控测试指标
3. **错误分析**: 分析失败请求的详细信息