# Vafast 性能基准测试套件

## 概述

这是一个专门为 Web 框架设计的极致性能测试套件，支持精确测试单个框架的特定接口性能。采用 K6 作为负载测试工具，提供冷启动时间、RPS、延迟等详细性能指标。

## 特点

- 🎯 **精确测试**：一次只测试一个框架的一个接口
- 📁 **分类存储**：按框架和接口分层存储测试报告
- ⏰ **时间追踪**：报告文件名包含精确到秒的时间戳
- 📊 **完整指标**：冷启动、RPS、延迟、成功率等详细数据
- 🛠  **简单易用**：命令行参数直观，易于自动化
- ⚡️ **极致性能**：无预热直接峰值测试，真实反映冷启动性能

## 快速开始

### 安装依赖

```bash
npm install
```

### 安装 K6

```bash
# macOS
brew install k6

# 其他平台请参考 K6 官方文档
```

### 基本使用

```bash
node run-k6-tests.js <框架名> <接口名>
```

**示例：**
```bash
# 测试 Elysia 框架的 JSON 序列化接口
node run-k6-tests.js elysia json

# 测试 Express 框架的数据库查询接口
node run-k6-tests.js express db
```

## 支持的框架

| 框架名 | 描述 | 目录 |
|--------|------|------|
| `vafast-mini` | Vafast Mini 框架测试 | `frameworks/vafast-mini` |
| `vafast` | Vafast 框架测试 | `frameworks/vafast` |
| `express` | Express 框架测试 | `frameworks/express` |
| `koa` | Koa 框架测试 | `frameworks/koa` |
| `hono` | Hono 框架测试 | `frameworks/hono` |
| `elysia` | Elysia 框架测试 | `frameworks/elysia` |

## 支持的接口

### 基础性能接口

| 接口名 | 中文名称 | HTTP方法 | 路径 | 描述 |
|--------|----------|----------|------|------|
| `json` | JSON序列化 | GET | `/techempower/json` | 测试简单JSON响应性能 |
| `plaintext` | 纯文本响应 | GET | `/techempower/plaintext` | 测试纯文本响应性能，最基础的性能指标 |

### 数据库操作接口

| 接口名 | 中文名称 | HTTP方法 | 路径 | 描述 |
|--------|----------|----------|------|------|
| `db` | 数据库查询 | GET | `/techempower/db?queries=1` | 测试数据库单次查询性能 |
| `updates` | 数据库更新 | GET | `/techempower/updates?queries=1` | 测试数据库更新操作性能 |

### 复杂处理接口

| 接口名 | 中文名称 | HTTP方法 | 路径 | 描述 |
|--------|----------|----------|------|------|
| `complex-json` | 复杂JSON序列化 | GET | `/techempower/complex-json?depth=5` | 测试复杂对象序列化性能 |
| `batch-process` | 批量数据处理 | POST | `/techempower/batch-process` | 测试批量数据处理性能 |
| `schema-validate` | Schema验证 | POST | `/schema/validate` | 测试JSON Schema验证性能 |

## 测试配置

### K6 测试参数

- **测试时长**: 10秒
- **用户数**: 0-100个虚拟用户（10秒内线性增长）
- **测试类型**: 极致性能测试（无预热，直接峰值）
- **优雅停止**: 5秒

### 性能指标

每次测试会收集以下指标：

- 🏆 **冷启动时间**: 第一次请求的响应时间
- ⚡️ **每秒请求数 (RPS)**: 平均请求吞吐量
- 📉 **平均延迟**: 所有请求的平均响应时间
- 📊 **P95延迟**: 95%请求的响应时间
- 🎯 **P99延迟**: 99%请求的响应时间
- 🚨 **错误率**: 请求失败的百分比
- 🎯 **总请求数**: 测试期间的总请求量

## 📊 性能测试结果

**测试时间**: 2025-08-21 19:54:40 (北京时间)

**测试配置**: 10秒极致性能测试，0-100用户线性增长

### 🏆 框架综合性能排名

| 排名 | 框架 | 平均RPS | 平均延迟 | 平均冷启动 | 平均错误率 | 总请求数 | 测试接口数 |
|------|------|---------|----------|------------|------------|----------|------------|
| 🥇 | **Elysia** | 39,663 | 1.04ms | 2.90ms | 0.000% | 2,777,174 | 7/7 |
| 🥈 | **Hono** | 37,987 | 1.07ms | 2.56ms | 0.000% | 2,660,514 | 7/7 |
| 🥉 | **Express** | 31,854 | 1.42ms | 3.68ms | 0.000% | 2,233,977 | 7/7 |
| 4 | **Vafast-Mini** | 31,124 | 1.34ms | 3.51ms | 0.000% | 2,179,544 | 7/7 |
| 5 | **Vafast** | 30,707 | 1.40ms | 3.70ms | 0.000% | 2,150,341 | 7/7 |
| 6 | **Koa** | 23,627 | 1.97ms | 5.48ms | 0.000% | 1,654,936 | 7/7 |

### 📊 JSON序列化 接口性能对比

| 排名 | 框架 | RPS | 平均延迟 | P95延迟 | P99延迟 | 冷启动 | 错误率 | 总请求数 |
|------|------|-----|----------|---------|---------|--------|--------|----------|
| 🥇 | **Elysia** | 41,719 | 0.95ms | 3.26ms | 6.11ms | 3.12ms | 0.000% | 417,235 |
| 🥈 | **Hono** | 40,838 | 1.01ms | 3.28ms | 6.11ms | 2.56ms | 0.000% | 409,027 |
| 🥉 | **Vafast** | 36,334 | 1.17ms | 3.88ms | 6.89ms | 3.04ms | 0.000% | 363,582 |
| 4 | **Express** | 36,320 | 1.17ms | 3.70ms | 6.62ms | 2.58ms | 0.000% | 363,291 |
| 5 | **Vafast-Mini** | 35,764 | 1.17ms | 3.93ms | 7.28ms | 3.84ms | 0.000% | 357,808 |
| 6 | **Koa** | 15,491 | 2.93ms | 10.33ms | 17.66ms | 8.47ms | 0.000% | 155,094 |

### 📊 纯文本响应 接口性能对比

| 排名 | 框架 | RPS | 平均延迟 | P95延迟 | P99延迟 | 冷启动 | 错误率 | 总请求数 |
|------|------|-----|----------|---------|---------|--------|--------|----------|
| 🥇 | **Elysia** | 43,068 | 0.91ms | 3.20ms | 5.91ms | 2.87ms | 0.000% | 430,855 |
| 🥈 | **Hono** | 41,383 | 0.98ms | 3.28ms | 6.09ms | 2.27ms | 0.000% | 414,032 |
| 🥉 | **Vafast** | 34,729 | 1.23ms | 4.01ms | 7.26ms | 2.64ms | 0.000% | 347,337 |
| 4 | **Express** | 34,554 | 1.24ms | 4.01ms | 7.08ms | 3.50ms | 0.000% | 345,678 |
| 5 | **Vafast-Mini** | 33,442 | 1.24ms | 4.31ms | 7.56ms | 3.58ms | 0.000% | 334,536 |
| 6 | **Koa** | 19,866 | 2.28ms | 7.37ms | 11.76ms | 6.35ms | 0.000% | 198,868 |

### 📊 数据库查询 接口性能对比

| 排名 | 框架 | RPS | 平均延迟 | P95延迟 | P99延迟 | 冷启动 | 错误率 | 总请求数 |
|------|------|-----|----------|---------|---------|--------|--------|----------|
| 🥇 | **Hono** | 41,211 | 0.99ms | 3.24ms | 5.95ms | 2.23ms | 0.000% | 412,322 |
| 🥈 | **Elysia** | 40,839 | 1.02ms | 3.34ms | 6.13ms | 2.60ms | 0.000% | 408,493 |
| 🥉 | **Express** | 34,558 | 1.24ms | 3.77ms | 6.84ms | 3.73ms | 0.000% | 348,860 |
| 4 | **Vafast** | 34,016 | 1.26ms | 4.01ms | 6.92ms | 3.33ms | 0.000% | 340,214 |
| 5 | **Vafast-Mini** | 31,585 | 1.32ms | 4.37ms | 7.89ms | 3.50ms | 0.000% | 316,010 |
| 6 | **Koa** | 27,727 | 1.62ms | 4.72ms | 7.53ms | 3.52ms | 0.000% | 277,439 |

### 📊 Schema验证 接口性能对比

| 排名 | 框架 | RPS | 平均延迟 | P95延迟 | P99延迟 | 冷启动 | 错误率 | 总请求数 |
|------|------|-----|----------|---------|---------|--------|--------|----------|
| 🥇 | **Elysia** | 34,086 | 1.24ms | 3.86ms | 6.86ms | 3.84ms | 0.000% | 340,970 |
| 🥈 | **Hono** | 27,158 | 1.29ms | 4.40ms | 7.91ms | 2.98ms | 0.000% | 271,655 |
| 🥉 | **Vafast** | 24,241 | 1.51ms | 5.13ms | 8.40ms | 4.34ms | 0.000% | 242,517 |
| 4 | **Vafast-Mini** | 24,179 | 1.45ms | 5.04ms | 8.81ms | 2.68ms | 0.000% | 241,977 |
| 5 | **Koa** | 21,677 | 1.83ms | 6.06ms | 9.64ms | 5.63ms | 0.000% | 216,822 |
| 6 | **Express** | 19,135 | 2.12ms | 7.18ms | 11.64ms | 5.62ms | 0.000% | 191,609 |

### ⚡️ 性能亮点

- 🏆 **最高RPS**: Elysia 框架的纯文本响应接口达到 **43,068 RPS**
- ⚡️ **最低延迟**: Elysia 框架的纯文本响应接口延迟仅 **0.91ms**
- 🚀 **最快冷启动**: Elysia 框架的数据库更新接口冷启动仅 **2.17ms**

### 🚀 性能分析

#### 综合性能表现

1. **Elysia** 以平均 39,663 RPS 领跑，展现了现代 TypeScript 框架的极致性能
2. **Hono** 以平均 37,987 RPS 紧随其后，在轻量级框架中表现卓越
3. **Express** 以平均 31,854 RPS 证明了传统框架的持续优化成果
4. **Vafast** 系列框架表现稳定，在中等性能区间提供了良好的开发体验

#### 接口性能特点

- **纯文本响应**: 所有现代框架都能达到 30,000+ RPS，性能差距较小
- **JSON 序列化**: Elysia 和 Hono 在 JSON 处理上有明显优势
- **数据库操作**: Hono 在数据库查询场景表现最佳
- **Schema 验证**: Elysia 在复杂验证场景中保持领先

#### 延迟表现

- 所有框架的平均延迟都在 2ms 以内，响应速度极快
- Elysia 和 Hono 在延迟控制方面表现最佳
- 冷启动时间普遍在 5ms 以内，满足实时应用需求

## 报告结构

测试报告按照框架和接口分层存储：

```
test-results/
├── elysia/
│   ├── json/
│   │   ├── performance-report-2025-08-21_19-35-15.json
│   │   └── performance-report-2025-08-21_19-28-07.json
│   ├── plaintext/
│   │   └── performance-report-2025-08-21_19-35-38.json
│   └── db/
│       └── performance-report-2025-08-21_19-36-00.json
├── express/
│   ├── json/
│   └── plaintext/
└── hono/
    ├── json/
    └── plaintext/
```

### 报告文件格式

```json
{
  "framework": "elysia",
  "endpoint": "json",
  "beijingTime": "2025-08-21 19:35:15+08:00",
  "timestamp": "2025-08-21_19-35-15",
  "results": {
    "coldStart": {
      "emoji": "👑",
      "name": "冷启动",
      "value": "3.12 ms",
      "description": "3.12 ms. 无延迟，无妥协。冷启动王者之冠属于我们。"
    },
    "requestsPerSecond": {
      "emoji": "⚡️",
      "name": "每秒请求数",
      "value": "41,719 rps",
      "description": "为瞬时流量而生 — 无需预热。"
    }
    // ... 更多指标
  },
  "summary": {
    "totalRequests": 417235,
    "testDuration": 10,
    "rps": 41719.88,
    "avgLatency": 0.95,
    "p95Latency": 3.26,
    "p99Latency": 6.11,
    "errorRate": 0,
    "coldStart": 3.12,
    "totalEndpoints": 1,
    "testedEndpoints": ["JSON序列化"]
  }
}
```

## 性能评估标准

### RPS (每秒请求数) 评级

- 🏆 **极致性能**: RPS > 50,000
- 🥇 **优秀性能**: RPS > 30,000  
- 🥈 **良好性能**: RPS > 20,000
- 🥉 **一般性能**: RPS < 20,000

### 响应延迟评级

- ⚡️ **极速响应**: 平均延迟 < 1ms
- 🚀 **快速响应**: 平均延迟 < 5ms
- ✅ **正常响应**: 平均延迟 < 20ms
- ⚠️ **响应较慢**: 平均延迟 > 20ms

## 使用示例

### 测试单个接口

```bash
# 测试 Elysia 框架的 JSON 序列化性能
node run-k6-tests.js elysia json
```

### 批量测试所有接口

```bash
#!/bin/bash
# 测试 Elysia 框架的所有接口

interfaces=("json" "plaintext" "db" "updates" "complex-json" "batch-process" "schema-validate")

for interface in "${interfaces[@]}"; do
  echo "Testing elysia $interface..."
  node run-k6-tests.js elysia "$interface"
  echo "Completed elysia $interface test"
  echo "---"
done
```

### 比较不同框架

```bash
#!/bin/bash
# 比较不同框架的 JSON 序列化性能

frameworks=("elysia" "hono" "express" "koa" "vafast" "vafast-mini")

for framework in "${frameworks[@]}"; do
  echo "Testing $framework json..."
  node run-k6-tests.js "$framework" json
  sleep 2  # 给服务器一些恢复时间
done
```

### 全面性能测试

```bash
# 运行所有框架的所有接口测试
./test-all-frameworks.sh

# 分析和生成报告
node analyze-results.js
```

## 帮助信息

```bash
node run-k6-tests.js --help
# 或
node run-k6-tests.js -h
```

## 技术架构

### 主要组件

1. **主脚本** (`run-k6-tests.js`)
   - 服务器生命周期管理
   - K6 测试流程控制
   - 报告目录管理
   - 使用 date-fns 进行时间格式化

2. **K6 配置模板** (`k6-config-template.js`)
   - 独立的测试逻辑
   - 性能指标收集
   - 结果格式化和输出

3. **框架实现** (`frameworks/*/src/index.ts`)
   - 各框架的具体实现
   - 统一的接口定义
   - 性能优化代码

4. **批量测试脚本** (`test-all-frameworks.sh`)
   - 自动化全面性能测试
   - 测试进度跟踪
   - 结果统计和报告

5. **结果分析脚本** (`analyze-results.js`)
   - 自动分析测试结果
   - 生成性能对比报告
   - 识别性能亮点

### 依赖项

- **K6**: 负载测试工具
- **Node.js**: 运行环境
- **date-fns & date-fns-tz**: 时间格式化
- **各框架依赖**: Elysia, Hono, Express, Koa, Vafast 等

## 故障排除

### 常见问题

1. **K6 未安装**
   ```bash
   brew install k6  # macOS
   ```

2. **端口被占用**
   ```bash
   lsof -ti:3000 | xargs kill -9
   ```

3. **服务器启动超时**
   - 检查框架依赖是否安装
   - 确保端口 3000 可用

4. **测试失败**
   - 查看错误日志
   - 确认接口名称拼写正确
   - 检查框架是否支持该接口

5. **schema-validate 接口匹配问题**
   - 已修复接口匹配逻辑
   - 特殊处理 `/schema/validate` 路径

## 贡献指南

1. Fork 项目
2. 创建特性分支
3. 添加新的框架或接口
4. 确保测试通过
5. 提交 Pull Request

## 许可证

MIT License

## 更新日志

### v2.0.0 (2025-08-21)
- 🎯 全新的接口级精确测试系统
- 📁 分层报告存储结构 (框架/接口/时间戳)
- ⚡️ 支持 7 个性能测试接口类型
- 🔧 独立的 K6 配置文件架构
- 📊 完整的性能测试结果 (43 个测试完成)
- 🕐 使用 date-fns 进行专业时间格式化
- 🚀 自动化批量测试和结果分析
- 🐛 修复 schema-validate 接口匹配问题